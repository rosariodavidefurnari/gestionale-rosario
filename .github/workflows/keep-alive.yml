name: Supabase Keep Alive

on:
  schedule:
    # Run every Monday and Thursday at 08:00 UTC (09:00 Italian time)
    - cron: "0 8 * * 1,4"
  workflow_dispatch: # Allow manual trigger from Actions tab

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          HTTP_STATUS=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            "$SUPABASE_URL/rest/v1/keep_alive?select=id,name,pinged_at&limit=1" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY")

          echo "HTTP Status: $HTTP_STATUS"
          echo "Response:"
          cat /tmp/response.json

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Supabase ping successful â€” project is active"
          else
            echo "ERROR: Supabase responded with status $HTTP_STATUS"
            echo "Check: 1) URL and KEY are correct 2) keep_alive table exists 3) RLS policy is active"
            exit 1
          fi
